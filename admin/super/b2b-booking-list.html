<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1.0">
	<title>SMART TRAVEL ADMIN</title>

	<!--   -->
	<link rel="shortcut icon" href="../image/favicon.ico">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="../css/a_reset.css">
	<link rel="stylesheet" href="../css/a_variables.css">
	<link rel="stylesheet" href="../css/a_components.css?v=20251231">
	<link rel="stylesheet" href="../css/a_contents.css?v=20251231">

	<!--   ( ) -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css">
	<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/moment.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
	<style>
		/* 정렬 가능 컬럼 스타일 */
		th.sortable {
			user-select: none;
		}
		th.sortable:hover {
			background-color: #f5f5f5;
		}
		th.sortable .th-content {
			display: inline-flex;
			align-items: center;
			gap: 4px;
		}
		th.sortable .sort-icon {
			display: inline-block;
			width: 16px;
			height: 16px;
			vertical-align: middle;
		}
		th.sortable .sort-icon::after {
			content: '⇅';
			font-size: 12px;
			color: #999;
		}
		th.sortable.sort-asc .sort-icon::after {
			content: '▲';
			color: #333;
		}
		th.sortable.sort-desc .sort-icon::after {
			content: '▼';
			color: #333;
		}

		/* 페이지네이션 스타일 */
		.pagination-wrap {
			display: flex;
			justify-content: center;
			align-items: center;
			gap: 4px;
			margin-top: 16px;
			padding: 12px 0;
		}
		.pagination-wrap:empty {
			display: none;
		}
		.pagination-wrap .page-btn {
			min-width: 32px;
			height: 32px;
			padding: 0 8px;
			border: 1px solid #d4d4d4;
			background: #fff;
			border-radius: 6px;
			font-size: 14px;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
		}
		.pagination-wrap .page-btn:hover {
			background: #f5f5f5;
		}
		.pagination-wrap .page-btn.active {
			background: #3b82f6;
			color: #fff;
			border-color: #3b82f6;
		}
		.pagination-wrap .page-btn:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}
		.pagination-wrap .page-info {
			margin: 0 8px;
			font-size: 14px;
			color: #666;
		}
	</style>
</head>

<body>

	<!-- header   -->
	<header class="layout-header"></header>

	<!--   -->
	<main class="layout-main">
		<!-- nav   -->
		<nav class="layout-nav"></nav>

		<section class="layout-content">

			<h1 class="page-title" data-lan-eng="B2B Reservation List">B2B Reservation List</h1>

			<!-- 검색 필터 영역 -->
			<div class="card-panel jw-mgt32">
				<div class="list-header">
					<div class="result-count">
						<span data-lan-eng="Total">Total</span> <span class="result-count__num" id="totalCount">0</span><span data-lan-eng="items">items</span>
					</div>
					<form class="search-form" action="" method="get" id="filterForm" onsubmit="applyFilters(); return false;">
						<div class="grid-item">
							<input id="travelStartDate" type="text" placeholder="Travel start date" readonly data-lan-eng-placeholder="Travel start date" style="width:200px !important; height:46px !important; border:1px solid #D4D4D4 !important; border-radius:12px !important; padding:0 40px 0 16px !important; background:#fff url('../image/calendar.svg') no-repeat right 12px center !important; background-size:24px 24px !important; font-size:16px !important; color:#121212 !important; cursor:pointer !important;">
						</div>
						<div class="search-field">
							<select class="select" name="searchType" id="searchType" onchange="applyFilters()">
								<option value="all" data-lan-eng="All">All</option>
								<option value="product" data-lan-eng="Product Name">Product Name</option>
								<option value="agent" data-lan-eng="Agent Name">Agent Name</option>
							</select>
							<input type="text" class="search-input" id="searchInput" placeholder=" " data-lan-eng="Search" onkeyup="if(event.key==='Enter') applyFilters()">
							<button type="submit" class="jw-button search-btn" aria-label="" onclick="applyFilters(); return false;">
								<span class="search-ico"><img src="../image/search.svg" alt=""></span>
							</button>
						</div>
					</form>
				</div>
			</div>

			<!-- Section 1: Waiting Payment -->
			<div class="card-panel jw-mgt24" id="section-waiting">
				<div class="section-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; cursor:pointer;" onclick="toggleSection('waiting')">
					<h2 class="card-title" style="margin:0; display:flex; align-items:center; gap:8px;">
						<span style="display:inline-block; width:12px; height:12px; background:#3b82f6; border-radius:50%;"></span>
						<span data-lan-eng="Waiting Payment">Waiting Payment</span>
						<span class="section-count" id="waitingCount" style="background:#3b82f6; color:#fff; padding:2px 10px; border-radius:12px; font-size:13px;">0</span>
					</h2>
					<span class="toggle-icon" id="toggle-waiting" style="font-size:20px;">▼</span>
				</div>
				<div class="section-body" id="body-waiting">
					<table class="jw-tableA">
						<colgroup>
							<col style="width:50px;"><col style="width:200px;"><col style="width:100px;"><col style="width:100px;"><col style="width:130px;"><col style="width:50px;"><col style="width:110px;"><col style="width:180px;">
						</colgroup>
						<thead>
							<tr>
								<th class="no is-center">No</th>
								<th data-lan-eng="Product Name">Product Name</th>
								<th data-lan-eng="Travel start date" class="is-center sortable" onclick="toggleTravelDateSort()">
									<span class="th-content">
										<span class="th-text">Travel start date</span>
										<span class="sort-icon"></span>
									</span>
								</th>
								<th data-lan-eng="Date Booked" class="is-center">Date Booked</th>
								<th data-lan-eng="Agency Name" class="is-center">Agency Name</th>
								<th data-lan-eng="PAX" class="is-center">PAX</th>
								<th data-lan-eng="Assignment Guide" class="is-center">Assignment Guide</th>
								<th data-lan-eng="Status" class="is-center">Status</th>
							</tr>
						</thead>
						<tbody id="tbody-waiting"><tr><td colspan="8" class="is-center">Loading...</td></tr></tbody>
					</table>
					<div class="pagination-wrap" id="pagination-waiting"></div>
				</div>
			</div>

			<!-- Section 2: Checking Payment -->
			<div class="card-panel jw-mgt24" id="section-checking">
				<div class="section-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; cursor:pointer;" onclick="toggleSection('checking')">
					<h2 class="card-title" style="margin:0; display:flex; align-items:center; gap:8px;">
						<span style="display:inline-block; width:12px; height:12px; background:#f59e0b; border-radius:50%;"></span>
						<span data-lan-eng="Checking Payment">Checking Payment</span>
						<span class="section-count" id="checkingCount" style="background:#f59e0b; color:#fff; padding:2px 10px; border-radius:12px; font-size:13px;">0</span>
					</h2>
					<span class="toggle-icon" id="toggle-checking" style="font-size:20px;">▶</span>
				</div>
				<div class="section-body" id="body-checking" style="display:none;">
					<table class="jw-tableA">
						<colgroup>
							<col style="width:50px;"><col style="width:200px;"><col style="width:100px;"><col style="width:100px;"><col style="width:130px;"><col style="width:50px;"><col style="width:110px;"><col style="width:180px;">
						</colgroup>
						<thead>
							<tr>
								<th class="no is-center">No</th>
								<th data-lan-eng="Product Name">Product Name</th>
								<th data-lan-eng="Travel start date" class="is-center sortable" onclick="toggleTravelDateSort()">
									<span class="th-content">
										<span class="th-text">Travel start date</span>
										<span class="sort-icon"></span>
									</span>
								</th>
								<th data-lan-eng="Date Booked" class="is-center">Date Booked</th>
								<th data-lan-eng="Agency Name" class="is-center">Agency Name</th>
								<th data-lan-eng="PAX" class="is-center">PAX</th>
								<th data-lan-eng="Assignment Guide" class="is-center">Assignment Guide</th>
								<th data-lan-eng="Status" class="is-center">Status</th>
							</tr>
						</thead>
						<tbody id="tbody-checking"><tr><td colspan="8" class="is-center">Loading...</td></tr></tbody>
					</table>
					<div class="pagination-wrap" id="pagination-checking"></div>
				</div>
			</div>

			<!-- Section 3: Rejected -->
			<div class="card-panel jw-mgt24" id="section-rejected">
				<div class="section-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; cursor:pointer;" onclick="toggleSection('rejected')">
					<h2 class="card-title" style="margin:0; display:flex; align-items:center; gap:8px;">
						<span style="display:inline-block; width:12px; height:12px; background:#ef4444; border-radius:50%;"></span>
						<span data-lan-eng="Rejected">Rejected</span>
						<span class="section-count" id="rejectedCount" style="background:#ef4444; color:#fff; padding:2px 10px; border-radius:12px; font-size:13px;">0</span>
					</h2>
					<span class="toggle-icon" id="toggle-rejected" style="font-size:20px;">▶</span>
				</div>
				<div class="section-body" id="body-rejected" style="display:none;">
					<table class="jw-tableA">
						<colgroup>
							<col style="width:50px;"><col style="width:200px;"><col style="width:100px;"><col style="width:100px;"><col style="width:130px;"><col style="width:50px;"><col style="width:110px;"><col style="width:180px;">
						</colgroup>
						<thead>
							<tr>
								<th class="no is-center">No</th>
								<th data-lan-eng="Product Name">Product Name</th>
								<th data-lan-eng="Travel start date" class="is-center sortable" onclick="toggleTravelDateSort()">
									<span class="th-content">
										<span class="th-text">Travel start date</span>
										<span class="sort-icon"></span>
									</span>
								</th>
								<th data-lan-eng="Date Booked" class="is-center">Date Booked</th>
								<th data-lan-eng="Agency Name" class="is-center">Agency Name</th>
								<th data-lan-eng="PAX" class="is-center">PAX</th>
								<th data-lan-eng="Assignment Guide" class="is-center">Assignment Guide</th>
								<th data-lan-eng="Status" class="is-center">Status</th>
							</tr>
						</thead>
						<tbody id="tbody-rejected"><tr><td colspan="8" class="is-center">Loading...</td></tr></tbody>
					</table>
					<div class="pagination-wrap" id="pagination-rejected"></div>
				</div>
			</div>

			<!-- Section 4: Confirmed -->
			<div class="card-panel jw-mgt24" id="section-confirmed">
				<div class="section-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; cursor:pointer;" onclick="toggleSection('confirmed')">
					<h2 class="card-title" style="margin:0; display:flex; align-items:center; gap:8px;">
						<span style="display:inline-block; width:12px; height:12px; background:#22c55e; border-radius:50%;"></span>
						<span data-lan-eng="Confirmed">Confirmed</span>
						<span class="section-count" id="confirmedCount" style="background:#22c55e; color:#fff; padding:2px 10px; border-radius:12px; font-size:13px;">0</span>
					</h2>
					<span class="toggle-icon" id="toggle-confirmed" style="font-size:20px;">▶</span>
				</div>
				<div class="section-body" id="body-confirmed" style="display:none;">
					<table class="jw-tableA">
						<colgroup>
							<col style="width:50px;"><col style="width:200px;"><col style="width:100px;"><col style="width:100px;"><col style="width:130px;"><col style="width:50px;"><col style="width:110px;"><col style="width:180px;">
						</colgroup>
						<thead>
							<tr>
								<th class="no is-center">No</th>
								<th data-lan-eng="Product Name">Product Name</th>
								<th data-lan-eng="Travel start date" class="is-center sortable" onclick="toggleTravelDateSort()">
									<span class="th-content">
										<span class="th-text">Travel start date</span>
										<span class="sort-icon"></span>
									</span>
								</th>
								<th data-lan-eng="Date Booked" class="is-center">Date Booked</th>
								<th data-lan-eng="Agency Name" class="is-center">Agency Name</th>
								<th data-lan-eng="PAX" class="is-center">PAX</th>
								<th data-lan-eng="Assignment Guide" class="is-center">Assignment Guide</th>
								<th data-lan-eng="Status" class="is-center">Status</th>
							</tr>
						</thead>
						<tbody id="tbody-confirmed"><tr><td colspan="8" class="is-center">Loading...</td></tr></tbody>
					</table>
					<div class="pagination-wrap" id="pagination-confirmed"></div>
				</div>
			</div>

			<!-- Section 5: Cancelled -->
			<div class="card-panel jw-mgt24" id="section-cancelled">
				<div class="section-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; cursor:pointer;" onclick="toggleSection('cancelled')">
					<h2 class="card-title" style="margin:0; display:flex; align-items:center; gap:8px;">
						<span style="display:inline-block; width:12px; height:12px; background:#6b7280; border-radius:50%;"></span>
						<span data-lan-eng="Cancelled">Cancelled</span>
						<span class="section-count" id="cancelledCount" style="background:#6b7280; color:#fff; padding:2px 10px; border-radius:12px; font-size:13px;">0</span>
					</h2>
					<span class="toggle-icon" id="toggle-cancelled" style="font-size:20px;">▶</span>
				</div>
				<div class="section-body" id="body-cancelled" style="display:none;">
					<table class="jw-tableA">
						<colgroup>
							<col style="width:50px;"><col style="width:200px;"><col style="width:100px;"><col style="width:100px;"><col style="width:130px;"><col style="width:50px;"><col style="width:110px;"><col style="width:180px;">
						</colgroup>
						<thead>
							<tr>
								<th class="no is-center">No</th>
								<th data-lan-eng="Product Name">Product Name</th>
								<th data-lan-eng="Travel start date" class="is-center sortable" onclick="toggleTravelDateSort()">
									<span class="th-content">
										<span class="th-text">Travel start date</span>
										<span class="sort-icon"></span>
									</span>
								</th>
								<th data-lan-eng="Date Booked" class="is-center">Date Booked</th>
								<th data-lan-eng="Agency Name" class="is-center">Agency Name</th>
								<th data-lan-eng="PAX" class="is-center">PAX</th>
								<th data-lan-eng="Assignment Guide" class="is-center">Assignment Guide</th>
								<th data-lan-eng="Status" class="is-center">Status</th>
							</tr>
						</thead>
						<tbody id="tbody-cancelled"><tr><td colspan="8" class="is-center">Loading...</td></tr></tbody>
					</table>
					<div class="pagination-wrap" id="pagination-cancelled"></div>
				</div>
			</div>

			<div class="controller">
				<button type="button" class="jw-button typeA" id="downloadCsvBtn" data-lan-eng="Download">Download</button>
			</div>



		</section>

	</main>

	<!--   -->
	<script src="../js/default.js?v=20251226_b2bbookingfix1"></script>
	<script src="../js/super.js?v=20251226_b2bbookingfix1"></script>
	<script src="../js/datepicker.js?v=20251231"></script>

	<script>
		init({
			headerUrl: '../inc/header.html',
			navUrl: '../inc/nav_super.html'
		});

		let currentFilters = { search: '', travelStartDate: '', searchType: 'all', travelStartDateSort: '' };

		// 섹션별 상태 그룹 정의
		const sectionGroups = {
			waiting: ['waiting_down_payment', 'waiting_second_payment', 'waiting_balance', 'waiting_full_payment'],
			checking: ['checking_down_payment', 'checking_second_payment', 'checking_balance', 'checking_full_payment'],
			rejected: ['rejected'],
			confirmed: ['confirmed', 'completed'],
			cancelled: ['cancelled', 'refunded']
		};

		// 섹션 토글 상태 (waiting 펼침, 나머지 접힘)
		const sectionState = {
			waiting: true,
			checking: false,
			rejected: false,
			confirmed: false,
			cancelled: false
		};

		// 페이지네이션 설정
		const PAGE_SIZE = 10;
		const sectionData = {
			waiting: [],
			checking: [],
			rejected: [],
			confirmed: [],
			cancelled: []
		};
		const sectionPage = {
			waiting: 1,
			checking: 1,
			rejected: 1,
			confirmed: 1,
			cancelled: 1
		};

		document.addEventListener('DOMContentLoaded', async () => {
			try {
				const sessionResponse = await fetch('../backend/api/check-session.php', {
					credentials: 'same-origin'
				});
				const sessionData = await sessionResponse.json();

				if (!sessionData.authenticated) {
					window.location.href = '../index.html';
					return;
				}

				try {
					if (window.jQuery) {
						jQuery('#travelStartDate')
							.on('apply.daterangepicker', function () { applyFilters(); })
							.on('cancel.daterangepicker', function () { applyFilters(); });
					}
				} catch (_) { }

				await loadAllBookings();
				setupDownload();
			} catch (error) {
				console.error('Session check error:', error);
				window.location.href = '../index.html';
				return;
			}
		});

		function toggleSection(section) {
			const body = document.getElementById('body-' + section);
			const icon = document.getElementById('toggle-' + section);
			if (body && icon) {
				sectionState[section] = !sectionState[section];
				body.style.display = sectionState[section] ? 'block' : 'none';
				icon.textContent = sectionState[section] ? '▼' : '▶';
			}
		}

		function applyFilters() {
			currentFilters.search = document.getElementById('searchInput').value.trim();
			currentFilters.travelStartDate = document.getElementById('travelStartDate').value;
			currentFilters.searchType = document.getElementById('searchType')?.value || 'all';
			loadAllBookings();
		}

		function getSectionForStatus(statusKey) {
			const key = String(statusKey || '').toLowerCase().trim();
			for (const [section, statuses] of Object.entries(sectionGroups)) {
				if (statuses.includes(key)) return section;
			}
			return 'waiting'; // 기본값
		}

		async function loadAllBookings() {
			// 모든 섹션 로딩 상태로 변경
			['waiting', 'checking', 'rejected', 'confirmed', 'cancelled'].forEach(section => {
				const tbody = document.getElementById('tbody-' + section);
				if (tbody) tbody.innerHTML = '<tr><td colspan="8" class="is-center">Loading...</td></tr>';
			});

			try {
				// 전체 데이터를 가져오기 위해 limit을 크게 설정
				const params = new URLSearchParams({
					action: 'getB2BBookings',
					page: 1,
					limit: 1000
				});

				if (currentFilters.search) params.append('search', currentFilters.search);
				if (currentFilters.searchType) params.append('searchType', currentFilters.searchType);
				if (currentFilters.travelStartDate) params.append('travelStartDate', currentFilters.travelStartDate);
				if (currentFilters.travelStartDateSort) params.append('travelStartDateSort', currentFilters.travelStartDateSort);

				const response = await fetch(`../backend/api/super-api.php?${params.toString()}`, {
					credentials: 'same-origin'
				});

				if (!response.ok) throw new Error('HTTP ' + response.status);

				const result = await response.json();

				if (result.success && result.data) {
					const { bookings } = result.data;

					// 섹션별로 그룹화 (pending 제외 - 별도 페이지로 이동)
					const grouped = {
						waiting: [],
						checking: [],
						rejected: [],
						confirmed: [],
						cancelled: []
					};

					bookings.forEach(booking => {
						const statusKey = String(booking.statusKey || booking.bookingStatus || '').toLowerCase().trim();
						// pending 상태는 별도 페이지에서 처리하므로 제외
						if (statusKey === 'pending') return;
						const section = getSectionForStatus(statusKey);
						grouped[section].push(booking);
					});

					// 섹션별 데이터 저장 및 페이지 초기화
					let totalNonPending = 0;
					for (const [section, list] of Object.entries(grouped)) {
						sectionData[section] = list;
						sectionPage[section] = 1;
						totalNonPending += list.length;
						renderSection(section);
					}

					// 전체 카운트 표시 (pending 제외)
					const totalCountEl = document.getElementById('totalCount');
					if (totalCountEl) totalCountEl.textContent = totalNonPending;

					// 다국어 적용
					try {
						const lang = (typeof getCookie === 'function' ? (getCookie('lang') || 'eng') : 'eng');
						if (typeof language_apply === 'function') language_apply(lang);
					} catch (_) { }
				} else {
					['waiting', 'checking', 'rejected', 'confirmed', 'cancelled'].forEach(section => {
						const tbody = document.getElementById('tbody-' + section);
						if (tbody) tbody.innerHTML = '<tr><td colspan="8" class="is-center">Failed to load data.</td></tr>';
					});
				}
			} catch (error) {
				console.error('Error loading bookings:', error);
				['waiting', 'checking', 'rejected', 'confirmed', 'cancelled'].forEach(section => {
					const tbody = document.getElementById('tbody-' + section);
					if (tbody) tbody.innerHTML = '<tr><td colspan="8" class="is-center">Error loading data.</td></tr>';
				});
			}
		}

		function renderSection(section) {
			const tbody = document.getElementById('tbody-' + section);
			const countEl = document.getElementById(section + 'Count');
			const paginationEl = document.getElementById('pagination-' + section);
			const bookings = sectionData[section] || [];
			const currentPage = sectionPage[section] || 1;
			const totalPages = Math.ceil(bookings.length / PAGE_SIZE);

			if (countEl) countEl.textContent = bookings.length;

			if (!tbody) return;

			if (bookings.length === 0) {
				tbody.innerHTML = '<tr><td colspan="8" class="is-center" data-lan-eng="No data">No data</td></tr>';
				if (paginationEl) paginationEl.innerHTML = '';
				return;
			}

			// 현재 페이지 데이터만 추출
			const startIdx = (currentPage - 1) * PAGE_SIZE;
			const endIdx = startIdx + PAGE_SIZE;
			const pageBookings = bookings.slice(startIdx, endIdx);

			tbody.innerHTML = pageBookings.map((booking, index) => {
				const st = getStatusUi(booking);
				let dateBooked = '';
				if (booking.createdAt) {
					const d = new Date(booking.createdAt);
					if (!isNaN(d.getTime())) {
						dateBooked = d.toISOString().split('T')[0];
					}
				}
				const globalIndex = startIdx + index;

				return `
					<tr onclick="window.location.href='b2b-booking-detail.html?id=${escapeHtml(booking.bookingId)}'" style="cursor: pointer;">
						<td class="no is-center">${globalIndex + 1}</td>
						<td class="td-ellipsis"><span>${escapeHtml(booking.packageName || '')}</span></td>
						<td class="is-center">${escapeHtml(booking.departureDate || booking.travelStartDate || '')}</td>
						<td class="is-center">${escapeHtml(dateBooked)}</td>
						<td class="is-center">${escapeHtml(booking.agentName || booking.branchName || booking.companyName || '')}</td>
						<td class="is-center">${Number(booking.numberOfPeople || 0)}</td>
						<td class="is-center">${
							booking.guideName
								? escapeHtml(booking.guideName)
								: '<span data-lan-eng="Unassigned">Unassigned</span>'
						}</td>
						<td class="is-center"><span class="badge ${escapeHtml(st.className)}" data-lan-eng="${escapeHtml(st.dataLanEng)}">${escapeHtml(st.label)}</span></td>
					</tr>
				`;
			}).join('');

			// 페이지네이션 렌더링
			renderPagination(section, currentPage, totalPages);
		}

		function renderPagination(section, currentPage, totalPages) {
			const paginationEl = document.getElementById('pagination-' + section);
			if (!paginationEl) return;

			if (totalPages <= 1) {
				paginationEl.innerHTML = '';
				return;
			}

			let html = '';

			// 이전 버튼
			html += `<button class="page-btn" onclick="goToPage('${section}', ${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&lt;</button>`;

			// 페이지 번호들
			const maxVisiblePages = 5;
			let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
			let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

			if (endPage - startPage + 1 < maxVisiblePages) {
				startPage = Math.max(1, endPage - maxVisiblePages + 1);
			}

			if (startPage > 1) {
				html += `<button class="page-btn" onclick="goToPage('${section}', 1)">1</button>`;
				if (startPage > 2) {
					html += `<span class="page-info">...</span>`;
				}
			}

			for (let i = startPage; i <= endPage; i++) {
				html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage('${section}', ${i})">${i}</button>`;
			}

			if (endPage < totalPages) {
				if (endPage < totalPages - 1) {
					html += `<span class="page-info">...</span>`;
				}
				html += `<button class="page-btn" onclick="goToPage('${section}', ${totalPages})">${totalPages}</button>`;
			}

			// 다음 버튼
			html += `<button class="page-btn" onclick="goToPage('${section}', ${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>&gt;</button>`;

			paginationEl.innerHTML = html;
		}

		function goToPage(section, page) {
			const bookings = sectionData[section] || [];
			const totalPages = Math.ceil(bookings.length / PAGE_SIZE);

			if (page < 1 || page > totalPages) return;

			sectionPage[section] = page;
			renderSection(section);

			// 다국어 재적용
			try {
				const lang = (typeof getCookie === 'function' ? (getCookie('lang') || 'eng') : 'eng');
				if (typeof language_apply === 'function') language_apply(lang);
			} catch (_) { }
		}

		function getStatusUi(b) {
			const statusKey = String(b.statusKey || b.bookingStatus || '').toLowerCase().trim();

			const statusMap = {
				'waiting_down_payment': { label: 'Down Payment 대기', className: 'badge-wait-down', dataLanEng: 'Waiting for Down Payment' },
				'checking_down_payment': { label: 'Down Payment 확인중', className: 'badge-check-down', dataLanEng: 'Checking Down Payment' },
				'waiting_second_payment': { label: 'Second Payment 대기', className: 'badge-wait-second', dataLanEng: 'Waiting for Second Payment' },
				'checking_second_payment': { label: 'Second Payment 확인중', className: 'badge-check-second', dataLanEng: 'Checking Second Payment' },
				'waiting_balance': { label: 'Balance 대기', className: 'badge-wait-balance', dataLanEng: 'Waiting for Balance' },
				'checking_balance': { label: 'Balance 확인중', className: 'badge-check-balance', dataLanEng: 'Checking Balance' },
				'waiting_full_payment': { label: 'Full Payment 대기', className: 'badge-wait-full', dataLanEng: 'Waiting for Full Payment' },
				'checking_full_payment': { label: 'Full Payment 확인중', className: 'badge-check-full', dataLanEng: 'Checking Full Payment' },
				'rejected': { label: '증빙 거절', className: 'badge-rejected', dataLanEng: 'Payment Rejected' },
				'confirmed': { label: '예약 확정', className: 'badge-confirmed', dataLanEng: 'Reservation Confirmed' },
				'completed': { label: '여행 완료', className: 'badge-completed', dataLanEng: 'Trip Completed' },
				'cancelled': { label: '예약 취소', className: 'badge-cancelled', dataLanEng: 'Reservation Cancelled' },
				'refunded': { label: '환불 완료', className: 'badge-refunded', dataLanEng: 'Refund Completed' }
			};

			if (statusMap[statusKey]) {
				return statusMap[statusKey];
			}

			if (statusKey === 'pending') return statusMap['waiting_down_payment'];
			if (statusKey === 'partial') return statusMap['waiting_second_payment'];

			return { label: statusKey || '대기', className: 'badge-wait-down', dataLanEng: 'Waiting' };
		}

		function setupDownload() {
			const btn = document.getElementById('downloadCsvBtn');
			if (!btn || btn._bound) return;
			btn.addEventListener('click', () => {
				const params = new URLSearchParams({ action: 'exportB2BBookingsCsv' });
				if (currentFilters.search) params.append('search', currentFilters.search);
				if (currentFilters.searchType) params.append('searchType', currentFilters.searchType);
				if (currentFilters.travelStartDate) params.append('travelStartDate', currentFilters.travelStartDate);
				window.location.href = `../backend/api/super-api.php?${params.toString()}`;
			});
			btn._bound = true;
		}

		function escapeHtml(text) {
			const div = document.createElement('div');
			div.textContent = text;
			return div.innerHTML;
		}

		// Travel start date 정렬 토글 기능
		function toggleTravelDateSort() {
			// 정렬 상태 토글: '' -> 'asc' -> 'desc' -> ''
			if (currentFilters.travelStartDateSort === '') {
				currentFilters.travelStartDateSort = 'asc';
			} else if (currentFilters.travelStartDateSort === 'asc') {
				currentFilters.travelStartDateSort = 'desc';
			} else {
				currentFilters.travelStartDateSort = '';
			}

			// UI 업데이트
			updateSortIcon();

			// 데이터 다시 로드
			loadAllBookings();
		}

		// 정렬 아이콘 UI 업데이트
		function updateSortIcon() {
			// 모든 sortable 헤더에서 정렬 클래스 제거 후 현재 상태 적용
			document.querySelectorAll('th.sortable').forEach(th => {
				th.classList.remove('sort-asc', 'sort-desc');
				if (currentFilters.travelStartDateSort === 'asc') {
					th.classList.add('sort-asc');
				} else if (currentFilters.travelStartDateSort === 'desc') {
					th.classList.add('sort-desc');
				}
			});
		}
	</script>
</body>

</html>
