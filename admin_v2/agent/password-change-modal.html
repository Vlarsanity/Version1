<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Password Change Modal</title>
  
  <link rel="stylesheet" href="../../admin_v2/agent/css/modal.css"/>

</head>
<body>

<div class="modal-overlay">
  <div class="modal-container">
	
    <div class="modal-header">
      <h2 class="modal-title" data-lan-kor="비밀번호 변경">Change Password</h2>
      <button type="button" class="modal-close" id="closeDialog" aria-label="Close">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <form id="passwordChangeForm">
        <div id="errorMessage" class="error-message">
          <svg fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
          </svg>
          <span id="errorText"></span>
        </div>

        <div id="successMessage" class="success-message">
          <svg fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
          </svg>
          <span id="successText"></span>
        </div>

        <div class="form-group">
          <label for="currentPassword" class="form-label">
            <span data-lan-kor="현재 비밀번호">Current Password</span>
          </label>
          <div class="form-input-wrapper">
            <input
              type="password"
              id="currentPassword"
              name="currentPassword"
              class="form-input"
              placeholder="Enter your current password"
              required
            />
          </div>
        </div>

        <div class="form-group">
          <label for="newPassword" class="form-label">
            <span data-lan-kor="새 비밀번호">New Password</span>
          </label>
          <div class="form-input-wrapper">
            <input
              type="password"
              id="newPassword"
              name="newPassword"
              class="form-input"
              placeholder="Enter your new password"
              required
              minlength="8"
            />
          </div>
          <div class="password-strength" id="passwordStrength">
            <div class="strength-bar">
              <div class="strength-fill" id="strengthFill"></div>
            </div>
            <div class="strength-text" id="strengthText"></div>
          </div>
          <p class="form-hint">
            <svg fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
            </svg>
            <span data-lan-kor="최소 8자 이상, 숫자와 특수문자 포함 권장">At least 8 characters, include numbers and special characters</span>
          </p>
        </div>

        <div class="form-group">
          <label for="confirmPassword" class="form-label">
            <span data-lan-kor="새 비밀번호 확인">Confirm New Password</span>
          </label>
          <div class="form-input-wrapper">
            <input
              type="password"
              id="confirmPassword"
              name="confirmPassword"
              class="form-input"
              placeholder="Re-enter your new password"
              required
            />
          </div>
        </div>

        <div class="button-group">
          <button type="submit" class="btn btn-primary" id="submitBtn">
            <span class="spinner" id="spinner"></span>
            <span id="submitText" data-lan-kor="비밀번호 변경">Change Password</span>
          </button>
          <button type="button" class="btn btn-secondary" id="cancelBtn">
            <span data-lan-kor="취소">Cancel</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  (function () {
    function initModal() {
      const form = document.getElementById("passwordChangeForm");
      const cancelBtn = document.getElementById("cancelBtn");
      const closeBtn = document.getElementById("closeDialog");
      const submitBtn = document.getElementById("submitBtn");
      const spinner = document.getElementById("spinner");
      const submitText = document.getElementById("submitText");
      const newPasswordInput = document.getElementById("newPassword");
      const confirmPasswordInput = document.getElementById("confirmPassword");

      // Password strength checker
      newPasswordInput.addEventListener("input", function() {
        checkPasswordStrength(this.value);
      });

      // Confirm password validation
      confirmPasswordInput.addEventListener("input", function() {
        if (this.value && newPasswordInput.value !== this.value) {
          this.style.borderColor = "#ef4444";
        } else {
          this.style.borderColor = "#d1d5db";
        }
      });

      // Close button
      if (closeBtn) {
        closeBtn.addEventListener("click", closeModal);
      }

      // Cancel button
      if (cancelBtn) {
        cancelBtn.addEventListener("click", closeModal);
      }

      // Form submit
      if (form) {
        form.addEventListener("submit", function (e) {
          e.preventDefault();

          const currentPassword = document.getElementById("currentPassword").value;
          const newPassword = newPasswordInput.value;
          const confirmPassword = confirmPasswordInput.value;

          // Validation
          if (newPassword !== confirmPassword) {
            showError("New passwords do not match.");
            return;
          }

          if (newPassword.length < 8) {
            showError("Password must be at least 8 characters long.");
            return;
          }

          if (currentPassword === newPassword) {
            showError("New password must be different from current password.");
            return;
          }

          // Disable submit button and show spinner
          submitBtn.disabled = true;
          spinner.classList.add("show");
          submitText.textContent = "Changing...";

          // API call
          changePassword(currentPassword, newPassword);
        });
      }
    }

    function checkPasswordStrength(password) {
      const strengthIndicator = document.getElementById("passwordStrength");
      const strengthFill = document.getElementById("strengthFill");
      const strengthText = document.getElementById("strengthText");

      if (!password) {
        strengthIndicator.classList.remove("show");
        return;
      }

      strengthIndicator.classList.add("show");

      let strength = 0;
      if (password.length >= 8) strength++;
      if (password.length >= 12) strength++;
      if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
      if (/\d/.test(password)) strength++;
      if (/[^a-zA-Z\d]/.test(password)) strength++;

      strengthFill.className = "strength-fill";
      strengthText.className = "strength-text";

      if (strength <= 2) {
        strengthFill.classList.add("weak");
        strengthText.classList.add("weak");
        strengthText.textContent = "Weak";
      } else if (strength <= 3) {
        strengthFill.classList.add("medium");
        strengthText.classList.add("medium");
        strengthText.textContent = "Medium";
      } else {
        strengthFill.classList.add("strong");
        strengthText.classList.add("strong");
        strengthText.textContent = "Strong";
      }
    }

    function showError(message) {
      const errorMsg = document.getElementById("errorMessage");
      const errorText = document.getElementById("errorText");
      const successMsg = document.getElementById("successMessage");
      
      if (errorMsg && errorText) {
        errorText.textContent = message;
        errorMsg.classList.add("show");
        successMsg.classList.remove("show");
      }
    }

    function showSuccess(message) {
      const successMsg = document.getElementById("successMessage");
      const successText = document.getElementById("successText");
      const errorMsg = document.getElementById("errorMessage");
      
      if (successMsg && successText) {
        successText.textContent = message;
        successMsg.classList.add("show");
        errorMsg.classList.remove("show");
      }
    }

    function hideMessages() {
      const errorMsg = document.getElementById("errorMessage");
      const successMsg = document.getElementById("successMessage");
      
      if (errorMsg) errorMsg.classList.remove("show");
      if (successMsg) successMsg.classList.remove("show");
    }

    function closeModal() {
      if (typeof modal_close === "function") {
        modal_close();
      } else {
        // Fallback
        const overlay = document.querySelector(".modal-overlay");
        if (overlay) overlay.remove();
      }
    }

    function changePassword(currentPassword, newPassword) {
      const formData = new FormData();
      formData.append("action", "changePassword");
      formData.append("currentPassword", currentPassword);
      formData.append("newPassword", newPassword);

      fetch("../backend/api/agent-api.php", {
        method: "POST",
        body: formData,
      })
        .then((res) => res.json())
        .then((data) => {
          const submitBtn = document.getElementById("submitBtn");
          const spinner = document.getElementById("spinner");
          const submitText = document.getElementById("submitText");

          // Re-enable button
          submitBtn.disabled = false;
          spinner.classList.remove("show");
          submitText.textContent = "Change Password";

          if (data.success) {
            showSuccess("Password changed successfully!");
            
            // Close modal after 2 seconds
            setTimeout(() => {
              closeModal();
            }, 2000);
          } else {
            showError(data.message || "Failed to change password.");
          }
        })
        .catch((err) => {
          console.error("Password change error:", err);
          
          const submitBtn = document.getElementById("submitBtn");
          const spinner = document.getElementById("spinner");
          const submitText = document.getElementById("submitText");
          
          submitBtn.disabled = false;
          spinner.classList.remove("show");
          submitText.textContent = "Change Password";
          
          showError("An error occurred while changing password.");
        });
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initModal);
    } else {
      initModal();
    }
  })();
</script>


</html>