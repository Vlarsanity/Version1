<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Travel | Change Password</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/i18n-boot.css">
    <script src="../js/i18n-boot.js"></script>
    <script src="../js/i18n.js" defer></script>
    <script src="../js/auth-guard.js" defer></script>
    <script src="../js/button.js" defer></script>
    <script src="../js/password.js" defer></script>
    <script src="../js/profile.js" defer></script>
</head>
<body>
    <div class="main bg white mh100">
        <header class="header-type2">
            <a class="btn-mypage" href="#none"><img src="../images/ico_back_black.svg"></a>
            <div class="title">Change Password</div>
            <div></div>
        </header>
        <div class="px20 mt28">
            <label class="label-input" for="password1" data-i18n="currentPassword">Current Password</label>
            <div class="input-wrap1 mt14">
                <input class="input-type1" id="password" type="password" data-i18n-placeholder="passwordPlaceholder" placeholder="8-12 characters, including letters/numbers/special characters">
                <button class="btn-eye" type="button"><img src="../images/ico_eye_off.svg" alt=""></button>
            </div>
            <div class="fixed-bottom px20">
                <button class="btn primary lg inactive mt20" type="button" id="nextBtn" onclick="handlePasswordVerification()" data-i18n="next">Next</button>
            </div>
        </div>
        
    </div>

    <script>
        // NOTE
        (function() {
            function setupBackButton() {
                const backButton = document.querySelector('.btn-mypage');
                if (backButton) {
                    // NOTE
                    const newBackButton = backButton.cloneNode(true);
                    backButton.parentNode.replaceChild(newBackButton, backButton);
                    
                    // NOTE
                    newBackButton.addEventListener('click', function(e) {
                        e.preventDefault();
                    e.stopImmediatePropagation(); // stop all event propagation
                        
                        history.back();
                        return false;
                }, true); // run in capture phase
                } else {
                    // NOTE
                    setTimeout(setupBackButton, 50);
                }
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', setupBackButton);
            } else {
                // NOTE
                setupBackButton();
            }
        })();
        
        // NOTE
        document.addEventListener('DOMContentLoaded', async function() {
            // NOTE
            await loadServerTexts();
            
            // NOTE
            const passwordInput = document.getElementById('password');
            const nextBtn = document.getElementById('nextBtn');
            
            if (passwordInput && nextBtn) {
                // SMT: current password can be any length (legacy accounts). Only require non-empty.
                const updateState = () => {
                    const ok = (passwordInput.value || '').trim().length > 0;
                    nextBtn.classList.toggle('inactive', !ok);
                    nextBtn.disabled = !ok;
                };
                passwordInput.addEventListener('input', updateState);
                updateState();
            }
        });

        // NOTE
        async function handlePasswordVerification() {
            const passwordInput = document.getElementById('password');
            const currentPassword = passwordInput?.value.trim();
            
            if (!currentPassword) {
                let currentLang = String(getCurrentLanguage?.() || localStorage.getItem('selectedLanguage') || 'en').toLowerCase();
                if (currentLang !== 'en' && currentLang !== 'tl') currentLang = 'en';
                const texts = globalLanguageTexts[currentLang] || globalLanguageTexts.en;
                alert(texts.enterAllRequiredFields || 'Please enter all required information.');
                return;
            }
            
            // SMT: resolve userId robustly (localStorage can be stale/missing)
            let userId =
                localStorage.getItem('userId') ||
                localStorage.getItem('accountId') ||
                (() => {
                    try { return JSON.parse(localStorage.getItem('userProfile') || '{}')?.accountId || null; } catch (_) { return null; }
                })();
            if (!userId) {
                try {
                    const sessionRes = await fetch('../backend/api/check-session.php', { credentials: 'include' });
                    const sessionData = await sessionRes.json().catch(() => ({}));
                    if (sessionData?.authenticated && sessionData?.accountId) {
                        userId = sessionData.accountId;
                        try { localStorage.setItem('userId', String(userId)); } catch (_) {}
                    }
                } catch (_) {}
            }
            if (!userId) {
                let currentLang = String(getCurrentLanguage?.() || localStorage.getItem('selectedLanguage') || 'en').toLowerCase();
                if (currentLang !== 'en' && currentLang !== 'tl') currentLang = 'en';
                const texts = globalLanguageTexts[currentLang] || globalLanguageTexts.en;
                alert(texts.loginRequired || 'Login is required.');
                location.href = 'login.html';
                return;
            }
            
            try {
                // NOTE
                const response = await fetch('../backend/api/profile.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'verify_password',
                        user_id: userId,
                        current_password: currentPassword
                    })
                });
                
                const result = await response.json();
                let currentLang = String(getCurrentLanguage?.() || localStorage.getItem('selectedLanguage') || 'en').toLowerCase();
                if (currentLang !== 'en' && currentLang !== 'tl') currentLang = 'en';
                const texts = globalLanguageTexts[currentLang] || globalLanguageTexts.en;
                
                if (result.success) {
                    // NOTE
                    location.href = 'new-password.html';
                } else {
                    // NOTE
                    if (response.status === 401 || response.status === 400 || response.status === 404) {
                        alert(texts.incorrectCurrentPassword || 'Current password is incorrect.');
                    } else {
                        alert(texts.passwordChangeError || 'An error occurred while changing password.');
                    }
                }
                
            } catch (error) {
                console.error('Password verification error:', error);
                let currentLang = String(getCurrentLanguage?.() || localStorage.getItem('selectedLanguage') || 'en').toLowerCase();
                if (currentLang !== 'en' && currentLang !== 'tl') currentLang = 'en';
                const texts = globalLanguageTexts[currentLang] || globalLanguageTexts.en;
                alert(texts.passwordChangeError || 'An error occurred while changing password.');
            }
        }
    </script>
</body>
</html>